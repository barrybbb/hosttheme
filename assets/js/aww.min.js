$(function() {
	$.extend($.support, {
		touch : typeof Touch == "object"
	});
	if (document.addEventListener) {
		document.addEventListener("touchstart", iPadTouchHandler, false);
		document.addEventListener("touchmove", iPadTouchHandler, false);
		document.addEventListener("touchend", iPadTouchHandler, false);
		document.addEventListener("touchcancel", iPadTouchHandler, false)
	}
});
var lastTap = null;
var tapValid = false;
var tapTimeout = null;
function cancelTap() {
	tapValid = false
}
var rightClickPending = false;
var rightClickEvent = null;
var holdTimeout = null;
var cancelMouseUp = false;
function cancelHold() {
	if (rightClickPending) {
		window.clearTimeout(holdTimeout);
		rightClickPending = false;
		rightClickEvent = null
	}
}
function startHold(b) {
	if (rightClickPending) {
		return
	}
	rightClickPending = true;
	rightClickEvent = (b.changedTouches)[0];
	holdTimeout = window.setTimeout("doRightClick();", 800)
}
function doRightClick() {
	rightClickPending = false;
	var c = rightClickEvent, b = document.createEvent("MouseEvent");
	b.initMouseEvent("mouseup", true, true, window, 1, c.screenX, c.screenY,
			c.clientX, c.clientY, false, false, false, false, 0, null);
	c.target.dispatchEvent(b);
	b = document.createEvent("MouseEvent");
	b.initMouseEvent("mousedown", true, true, window, 1, c.screenX, c.screenY,
			c.clientX, c.clientY, false, false, false, false, 2, null);
	c.target.dispatchEvent(b);
	b = document.createEvent("MouseEvent");
	b.initMouseEvent("contextmenu", true, true, window, 1, c.screenX + 50,
			c.screenY + 5, c.clientX + 50, c.clientY + 5, false, false, false,
			false, 2, null);
	c.target.dispatchEvent(b);
	cancelMouseUp = true;
	rightClickEvent = null
}
function iPadTouchStart(d) {
	var f = d.changedTouches, e = f[0], b = "mouseover", c = document
			.createEvent("MouseEvent");
	c.initMouseEvent(b, true, true, window, 1, e.screenX, e.screenY, e.clientX,
			e.clientY, false, false, false, false, 0, null);
	e.target.dispatchEvent(c);
	b = "mousedown";
	c = document.createEvent("MouseEvent");
	c.initMouseEvent(b, true, true, window, 1, e.screenX, e.screenY, e.clientX,
			e.clientY, false, false, false, false, 0, null);
	e.target.dispatchEvent(c);
	if (!tapValid) {
		lastTap = e.target;
		tapValid = true;
		tapTimeout = window.setTimeout("cancelTap();", 600);
		startHold(d)
	} else {
		window.clearTimeout(tapTimeout);
		if (e.target == lastTap) {
			lastTap = null;
			tapValid = false;
			b = "click";
			c = document.createEvent("MouseEvent");
			c.initMouseEvent(b, true, true, window, 1, e.screenX, e.screenY,
					e.clientX, e.clientY, false, false, false, false, 0, null);
			e.target.dispatchEvent(c);
			b = "dblclick";
			c = document.createEvent("MouseEvent");
			c.initMouseEvent(b, true, true, window, 1, e.screenX, e.screenY,
					e.clientX, e.clientY, false, false, false, false, 0, null);
			e.target.dispatchEvent(c)
		} else {
			lastTap = e.target;
			tapValid = true;
			tapTimeout = window.setTimeout("cancelTap();", 600);
			startHold(d)
		}
	}
}
function iPadTouchHandler(e) {
	var c = "", b = 0;
	if (e.touches.length > 1) {
		return
	}
	switch (e.type) {
	case "touchstart":
		if ($(e.changedTouches[0].target).is("select")) {
			return
		}
		iPadTouchStart(e);
		e.preventDefault();
		return false;
		break;
	case "touchmove":
		cancelHold();
		c = "mousemove";
		e.preventDefault();
		break;
	case "touchend":
		if (cancelMouseUp) {
			cancelMouseUp = false;
			e.preventDefault();
			return false
		}
		cancelHold();
		c = "mouseup";
		break;
	default:
		return
	}
	var g = e.changedTouches, f = g[0], d = document.createEvent("MouseEvent");
	d.initMouseEvent(c, true, true, window, 1, f.screenX, f.screenY, f.clientX,
			f.clientY, false, false, false, false, b, null);
	f.target.dispatchEvent(d);
	if (c == "mouseup" && tapValid && f.target == lastTap) {
		d = document.createEvent("MouseEvent");
		d.initMouseEvent("click", true, true, window, 1, f.screenX, f.screenY,
				f.clientX, f.clientY, false, false, false, false, b, null);
		f.target.dispatchEvent(d)
	}
}
function JPEGEncoder(m) {
	var p = this;
	var t = Math.round;
	var l = Math.floor;
	var P = new Array(64);
	var L = new Array(64);
	var e = new Array(64);
	var aa = new Array(64);
	var v;
	var i;
	var H;
	var U;
	var o = new Array(65535);
	var n = new Array(65535);
	var Q = new Array(64);
	var T = new Array(64);
	var k = [];
	var u = 0;
	var b = 7;
	var B = new Array(64);
	var g = new Array(64);
	var V = new Array(64);
	var f = new Array(256);
	var D = new Array(2048);
	var y;
	var j = [ 0, 1, 5, 6, 14, 15, 27, 28, 2, 4, 7, 13, 16, 26, 29, 42, 3, 8,
			12, 17, 25, 30, 41, 43, 9, 11, 18, 24, 31, 40, 44, 53, 10, 19, 23,
			32, 39, 45, 52, 54, 20, 22, 33, 38, 46, 51, 55, 60, 21, 34, 37, 47,
			50, 56, 59, 61, 35, 36, 48, 49, 57, 58, 62, 63 ];
	var h = [ 0, 0, 1, 5, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0 ];
	var d = [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11 ];
	var x = [ 0, 0, 2, 1, 3, 3, 2, 4, 3, 5, 5, 4, 4, 0, 0, 1, 125 ];
	var F = [ 1, 2, 3, 0, 4, 17, 5, 18, 33, 49, 65, 6, 19, 81, 97, 7, 34, 113,
			20, 50, 129, 145, 161, 8, 35, 66, 177, 193, 21, 82, 209, 240, 36,
			51, 98, 114, 130, 9, 10, 22, 23, 24, 25, 26, 37, 38, 39, 40, 41,
			42, 52, 53, 54, 55, 56, 57, 58, 67, 68, 69, 70, 71, 72, 73, 74, 83,
			84, 85, 86, 87, 88, 89, 90, 99, 100, 101, 102, 103, 104, 105, 106,
			115, 116, 117, 118, 119, 120, 121, 122, 131, 132, 133, 134, 135,
			136, 137, 138, 146, 147, 148, 149, 150, 151, 152, 153, 154, 162,
			163, 164, 165, 166, 167, 168, 169, 170, 178, 179, 180, 181, 182,
			183, 184, 185, 186, 194, 195, 196, 197, 198, 199, 200, 201, 202,
			210, 211, 212, 213, 214, 215, 216, 217, 218, 225, 226, 227, 228,
			229, 230, 231, 232, 233, 234, 241, 242, 243, 244, 245, 246, 247,
			248, 249, 250 ];
	var w = [ 0, 0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0 ];
	var Z = [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11 ];
	var K = [ 0, 0, 2, 1, 2, 4, 4, 3, 4, 7, 5, 4, 4, 0, 1, 2, 119 ];
	var C = [ 0, 1, 2, 3, 17, 4, 5, 33, 49, 6, 18, 65, 81, 7, 97, 113, 19, 34,
			50, 129, 8, 20, 66, 145, 161, 177, 193, 9, 35, 51, 82, 240, 21, 98,
			114, 209, 10, 22, 36, 52, 225, 37, 241, 23, 24, 25, 26, 38, 39, 40,
			41, 42, 53, 54, 55, 56, 57, 58, 67, 68, 69, 70, 71, 72, 73, 74, 83,
			84, 85, 86, 87, 88, 89, 90, 99, 100, 101, 102, 103, 104, 105, 106,
			115, 116, 117, 118, 119, 120, 121, 122, 130, 131, 132, 133, 134,
			135, 136, 137, 138, 146, 147, 148, 149, 150, 151, 152, 153, 154,
			162, 163, 164, 165, 166, 167, 168, 169, 170, 178, 179, 180, 181,
			182, 183, 184, 185, 186, 194, 195, 196, 197, 198, 199, 200, 201,
			202, 210, 211, 212, 213, 214, 215, 216, 217, 218, 226, 227, 228,
			229, 230, 231, 232, 233, 234, 242, 243, 244, 245, 246, 247, 248,
			249, 250 ];
	function N(ah) {
		var ag = [ 16, 11, 10, 16, 24, 40, 51, 61, 12, 12, 14, 19, 26, 58, 60,
				55, 14, 13, 16, 24, 40, 57, 69, 56, 14, 17, 22, 29, 51, 87, 80,
				62, 18, 22, 37, 56, 68, 109, 103, 77, 24, 35, 55, 64, 81, 104,
				113, 92, 49, 64, 78, 87, 103, 121, 120, 101, 72, 92, 95, 98,
				112, 100, 103, 99 ];
		for (var af = 0; af < 64; af++) {
			var ak = l((ag[af] * ah + 50) / 100);
			if (ak < 1) {
				ak = 1
			} else {
				if (ak > 255) {
					ak = 255
				}
			}
			P[j[af]] = ak
		}
		var ai = [ 17, 18, 24, 47, 99, 99, 99, 99, 18, 21, 26, 66, 99, 99, 99,
				99, 24, 26, 56, 99, 99, 99, 99, 99, 47, 66, 99, 99, 99, 99, 99,
				99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99,
				99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99,
				99 ];
		for (var ae = 0; ae < 64; ae++) {
			var aj = l((ai[ae] * ah + 50) / 100);
			if (aj < 1) {
				aj = 1
			} else {
				if (aj > 255) {
					aj = 255
				}
			}
			L[j[ae]] = aj
		}
		var ad = [ 1, 1.387039845, 1.306562965, 1.175875602, 1, 0.785694958,
				0.5411961, 0.275899379 ];
		var ac = 0;
		for (var al = 0; al < 8; al++) {
			for (var ab = 0; ab < 8; ab++) {
				e[ac] = (1 / (P[j[ac]] * ad[al] * ad[ab] * 8));
				aa[ac] = (1 / (L[j[ac]] * ad[al] * ad[ab] * 8));
				ac++
			}
		}
	}
	function r(af, ab) {
		var ae = 0;
		var ah = 0;
		var ag = new Array();
		for (var ac = 1; ac <= 16; ac++) {
			for (var ad = 1; ad <= af[ac]; ad++) {
				ag[ab[ah]] = [];
				ag[ab[ah]][0] = ae;
				ag[ab[ah]][1] = ac;
				ah++;
				ae++
			}
			ae *= 2
		}
		return ag
	}
	function X() {
		v = r(h, d);
		i = r(w, Z);
		H = r(x, F);
		U = r(K, C)
	}
	function A() {
		var ad = 1;
		var ac = 2;
		for (var ab = 1; ab <= 15; ab++) {
			for (var ae = ad; ae < ac; ae++) {
				n[32767 + ae] = ab;
				o[32767 + ae] = [];
				o[32767 + ae][1] = ab;
				o[32767 + ae][0] = ae
			}
			for (var af = -(ac - 1); af <= -ad; af++) {
				n[32767 + af] = ab;
				o[32767 + af] = [];
				o[32767 + af][1] = ab;
				o[32767 + af][0] = ac - 1 + af
			}
			ad <<= 1;
			ac <<= 1
		}
	}
	function W() {
		for (var ab = 0; ab < 256; ab++) {
			D[ab] = 19595 * ab;
			D[(ab + 256) >> 0] = 38470 * ab;
			D[(ab + 512) >> 0] = 7471 * ab + 32768;
			D[(ab + 768) >> 0] = -11059 * ab;
			D[(ab + 1024) >> 0] = -21709 * ab;
			D[(ab + 1280) >> 0] = 32768 * ab + 8421375;
			D[(ab + 1536) >> 0] = -27439 * ab;
			D[(ab + 1792) >> 0] = -5329 * ab
		}
	}
	function Y(ab) {
		var ad = ab[0];
		var ac = ab[1] - 1;
		while (ac >= 0) {
			if (ad & (1 << ac)) {
				u |= (1 << b)
			}
			ac--;
			b--;
			if (b < 0) {
				if (u == 255) {
					G(255);
					G(0)
				} else {
					G(u)
				}
				b = 7;
				u = 0
			}
		}
	}
	function G(ab) {
		k.push(f[ab])
	}
	function q(ab) {
		G((ab >> 8) & 255);
		G((ab) & 255)
	}
	function O(a0, aq) {
		var aM, aL, aK, aJ, aI, aE, aD, aC;
		var aO = 0;
		var aS;
		var ar = 8;
		var aj = 64;
		for (aS = 0; aS < ar; ++aS) {
			aM = a0[aO];
			aL = a0[aO + 1];
			aK = a0[aO + 2];
			aJ = a0[aO + 3];
			aI = a0[aO + 4];
			aE = a0[aO + 5];
			aD = a0[aO + 6];
			aC = a0[aO + 7];
			var aZ = aM + aC;
			var aP = aM - aC;
			var aY = aL + aD;
			var aQ = aL - aD;
			var aV = aK + aE;
			var aR = aK - aE;
			var aU = aJ + aI;
			var aT = aJ - aI;
			var ao = aZ + aU;
			var al = aZ - aU;
			var an = aY + aV;
			var am = aY - aV;
			a0[aO] = ao + an;
			a0[aO + 4] = ao - an;
			var ay = (am + al) * 0.707106781;
			a0[aO + 2] = al + ay;
			a0[aO + 6] = al - ay;
			ao = aT + aR;
			an = aR + aQ;
			am = aQ + aP;
			var au = (ao - am) * 0.382683433;
			var ax = 0.5411961 * ao + au;
			var av = 1.306562965 * am + au;
			var aw = an * 0.707106781;
			var ai = aP + aw;
			var ah = aP - aw;
			a0[aO + 5] = ah + ax;
			a0[aO + 3] = ah - ax;
			a0[aO + 1] = ai + av;
			a0[aO + 7] = ai - av;
			aO += 8
		}
		aO = 0;
		for (aS = 0; aS < ar; ++aS) {
			aM = a0[aO];
			aL = a0[aO + 8];
			aK = a0[aO + 16];
			aJ = a0[aO + 24];
			aI = a0[aO + 32];
			aE = a0[aO + 40];
			aD = a0[aO + 48];
			aC = a0[aO + 56];
			var at = aM + aC;
			var ak = aM - aC;
			var aA = aL + aD;
			var af = aL - aD;
			var aH = aK + aE;
			var ad = aK - aE;
			var aX = aJ + aI;
			var ab = aJ - aI;
			var ap = at + aX;
			var aW = at - aX;
			var az = aA + aH;
			var aG = aA - aH;
			a0[aO] = ap + az;
			a0[aO + 32] = ap - az;
			var ag = (aG + aW) * 0.707106781;
			a0[aO + 16] = aW + ag;
			a0[aO + 48] = aW - ag;
			ap = ab + ad;
			az = ad + af;
			aG = af + ak;
			var aN = (ap - aG) * 0.382683433;
			var ae = 0.5411961 * ap + aN;
			var a2 = 1.306562965 * aG + aN;
			var ac = az * 0.707106781;
			var a1 = ak + ac;
			var aB = ak - ac;
			a0[aO + 40] = aB + ae;
			a0[aO + 24] = aB - ae;
			a0[aO + 8] = a1 + a2;
			a0[aO + 56] = a1 - a2;
			aO++
		}
		var aF;
		for (aS = 0; aS < aj; ++aS) {
			aF = a0[aS] * aq[aS];
			Q[aS] = (aF > 0) ? ((aF + 0.5) | 0) : ((aF - 0.5) | 0)
		}
		return Q
	}
	function c() {
		q(65504);
		q(16);
		G(74);
		G(70);
		G(73);
		G(70);
		G(0);
		G(1);
		G(1);
		G(0);
		q(1);
		q(1);
		G(0);
		G(0)
	}
	function s(ab, ac) {
		q(65472);
		q(17);
		G(8);
		q(ac);
		q(ab);
		G(3);
		G(1);
		G(17);
		G(0);
		G(2);
		G(17);
		G(1);
		G(3);
		G(17);
		G(1)
	}
	function E() {
		q(65499);
		q(132);
		G(0);
		for (var ac = 0; ac < 64; ac++) {
			G(P[ac])
		}
		G(1);
		for (var ab = 0; ab < 64; ab++) {
			G(L[ab])
		}
	}
	function I() {
		q(65476);
		q(418);
		G(0);
		for (var af = 0; af < 16; af++) {
			G(h[af + 1])
		}
		for (var ae = 0; ae <= 11; ae++) {
			G(d[ae])
		}
		G(16);
		for (var ad = 0; ad < 16; ad++) {
			G(x[ad + 1])
		}
		for (var ac = 0; ac <= 161; ac++) {
			G(F[ac])
		}
		G(1);
		for (var ab = 0; ab < 16; ab++) {
			G(w[ab + 1])
		}
		for (var ai = 0; ai <= 11; ai++) {
			G(Z[ai])
		}
		G(17);
		for (var ah = 0; ah < 16; ah++) {
			G(K[ah + 1])
		}
		for (var ag = 0; ag <= 161; ag++) {
			G(C[ag])
		}
	}
	function J() {
		q(65498);
		q(12);
		G(3);
		G(1);
		G(0);
		G(2);
		G(17);
		G(3);
		G(17);
		G(0);
		G(63);
		G(0)
	}
	function M(ae, ab, am, au, aq) {
		var ah = aq[0];
		var ac = aq[240];
		var ad;
		var at = 16;
		var aj = 63;
		var ai = 64;
		var ar = O(ae, ab);
		for (var an = 0; an < ai; ++an) {
			T[j[an]] = ar[an]
		}
		var ao = T[0] - am;
		am = T[0];
		if (ao == 0) {
			Y(au[0])
		} else {
			ad = 32767 + ao;
			Y(au[n[ad]]);
			Y(o[ad])
		}
		var af = 63;
		for (; (af > 0) && (T[af] == 0); af--) {
		}
		if (af == 0) {
			Y(ah);
			return am
		}
		var ap = 1;
		var av;
		while (ap <= af) {
			var al = ap;
			for (; (T[ap] == 0) && (ap <= af); ++ap) {
			}
			var ak = ap - al;
			if (ak >= at) {
				av = ak >> 4;
				for (var ag = 1; ag <= av; ++ag) {
					Y(ac)
				}
				ak = ak & 15
			}
			ad = 32767 + T[ap];
			Y(aq[(ak << 4) + n[ad]]);
			Y(o[ad]);
			ap++
		}
		if (af != aj) {
			Y(ah)
		}
		return am
	}
	function z() {
		var ac = String.fromCharCode;
		for (var ab = 0; ab < 256; ab++) {
			f[ab] = ac(ab)
		}
	}
	this.encode = function(ao, ak) {
		var ab = new Date().getTime();
		if (ak) {
			S(ak)
		}
		k = new Array();
		u = 0;
		b = 7;
		q(65496);
		c();
		E();
		s(ao.width, ao.height);
		I();
		J();
		var am = 0;
		var ar = 0;
		var ap = 0;
		u = 0;
		b = 7;
		this.encode.displayName = "_encode_";
		var au = ao.data;
		var at = ao.width;
		var az = ao.height;
		var ax = at * 4;
		var aj = at * 3;
		var ai, ah = 0;
		var an, aw, ay;
		var ac, aq, ad, ag, af;
		while (ah < az) {
			ai = 0;
			while (ai < ax) {
				ac = ax * ah + ai;
				aq = ac;
				ad = -1;
				ag = 0;
				for (af = 0; af < 64; af++) {
					ag = af >> 3;
					ad = (af & 7) * 4;
					aq = ac + (ag * ax) + ad;
					if (ah + ag >= az) {
						aq -= (ax * (ah + 1 + ag - az))
					}
					if (ai + ad >= ax) {
						aq -= ((ai + ad) - ax + 4)
					}
					an = au[aq++];
					aw = au[aq++];
					ay = au[aq++];
					a = au[aq++];
					if (a < 128) {
						an = 255;
						aw = 255;
						ay = 255
					}
					B[af] = ((D[an] + D[(aw + 256) >> 0] + D[(ay + 512) >> 0]) >> 16) - 128;
					g[af] = ((D[(an + 768) >> 0] + D[(aw + 1024) >> 0] + D[(ay + 1280) >> 0]) >> 16) - 128;
					V[af] = ((D[(an + 1280) >> 0] + D[(aw + 1536) >> 0] + D[(ay + 1792) >> 0]) >> 16) - 128
				}
				am = M(B, e, am, v, H);
				ar = M(g, aa, ar, i, U);
				ap = M(V, aa, ap, i, U);
				ai += 32
			}
			ah += 8
		}
		if (b >= 0) {
			var av = [];
			av[1] = b + 1;
			av[0] = (1 << (b + 1)) - 1;
			Y(av)
		}
		q(65497);
		var ae = "data:image/jpeg;base64," + btoa(k.join(""));
		k = [];
		var al = new Date().getTime() - ab;
		return ae
	};
	function S(ac) {
		if (ac <= 0) {
			ac = 1
		}
		if (ac > 100) {
			ac = 100
		}
		if (y == ac) {
			return
		}
		var ab = 0;
		if (ac < 50) {
			ab = Math.floor(5000 / ac)
		} else {
			ab = Math.floor(200 - ac * 2)
		}
		N(ab);
		y = ac
	}
	function R() {
		var ab = new Date().getTime();
		if (!m) {
			m = 50
		}
		z();
		X();
		A();
		W();
		S(m);
		var ac = new Date().getTime() - ab
	}
	R()
}
function getImageDataFromImage(d) {
	var b = (typeof (d) == "string") ? document.getElementById(d) : d;
	var e = document.createElement("canvas");
	e.width = b.width;
	e.height = b.height;
	var c = e.getContext("2d");
	c.drawImage(b, 0, 0);
	return (c.getImageData(0, 0, e.width, e.height))
}
(function(e) {
	var h = 2;
	var b = 5;
	var f = 10;
	var c = 20;
	var d = "bold 14px verdana, sans-serif";
	var g = {
		red : "#ed1c24",
		green : "#009945",
		blue : "#00a4ed",
		black : "#000",
		yellow : "#ffff00",
		brown : "#6b5534",
		purple : "#9b559b"
	};
	e.fn.awwCanvas = function(G) {
		if ((this.length == 1) && !G && e(this).data("aww")) {
			return e(this).data("aww")
		}

		var M = {
			apiKey : "",
			orientation : "auto",
			toolbar : true,
			smallIcons : false,
			shrinkCanvas : true,
			autoJoin : true,
			singleBoardId : null,
			invite_handler : null,
			post_handler : null,
			font : d,
			saveUrl : "",
			translation : {},
			msgbox_handler : function(aa) {
				alert(aa)
			},
			prompt_handler : function(ab, aa) {
				return prompt(ab, aa)
			},
			confirm_handler : function(aa) {
				return confirm(aa)
			},
			onReady : function() {
			}
		};
		G = e.extend(M, G);
		var T = document.createElement("canvas");
		if (!T) {
			return null
		}
		var C = false;
		if (window.G_vmlCanvasManager) {
			T.width = 1;
			T.height = 1;
			T = window.G_vmlCanvasManager.initElement(T);
			C = true
		}
		if (!T.getContext) {
			return null
		}
		var I = null;
		var l = null;
		var A = false;
		var W = false;
		function S(aa) {
			I = aa
		}
		function Q(aa) {
			l = aa
		}
		function Z(aa) {
			if (G.translation.hasOwnProperty(aa)) {
				return G.translation[aa]
			} else {
				return aa
			}
		}
		var L = e('<div class="awwcanvas">');
		function t(aa, ab) {
			return e("<li>").addClass(aa).append(
					e('<a href="">').attr("title", Z(ab)).append(e("<span>/"))
							.append(Z(ab)))
		}
		function tt(aa, ab, ac) {
			return e("<li>").addClass(aa).append(
					e('<a href="">').attr("title", Z(ab)).attr("id", ac).click(shareclick).append(e("<span>/"))
							.append(Z(ab)))
		}
		var r = e('<div class="toolbar">').appendTo(L);
		var q = e('<ul class="navigation">').appendTo(r);
		var V = t("color submenu", "Color").appendTo(q);
		var z = e("<ul>").append(t("red", "Red")).append(t("green", "Green"))
				.append(t("blue", "Blue")).append(t("black", "Black")).append(
						t("yellow", "Yellow")).append(t("brown", "Brown"))
				.append(t("purple", "Purple")).appendTo(V);
		var p = t("pencil submenu", "Pencil").appendTo(q);
		var D = e("<ul>").append(t("thin", "Thin")).append(
				t("medium", "Medium")).append(t("thick", "Thick")).append(
				t("text", "Text")).append(t("eraser", "Eraser")).appendTo(p);
		var J = t("menu submenu", "Menu").appendTo(q);
		var H = e("<ul>").append(t("new", "Clear")).append(t("share", "Invite")).append(t("link", "Post")).append(t("save", "Save")).appendTo(J);
		var User = t("user submenu", "User").appendTo(q);
		var FFF = e("<ul>").appendTo(User);
		function AddUser (nickname, id) {
			//alert("aww: "+nickname+", "+id);
			FFF = FFF.append(tt("123", nickname, id)).appendTo(User);
		}
		function o() {
			if (!G.toolbar) {
				L.addClass("notoolbar").removeClass(
						"aww-portrait aww-landscape smallcanvas");
				return
			}
			var aa = L.width();
			var ab = L.height();
			if ((aa < 550) || (ab < 550) || G.smallIcons) {
				L.addClass("smallcanvas")
			} else {
				L.removeClass("smallcanvas")
			}
			if ((G.orientation == "landscape")
					|| ((G.orientation == "auto") && (aa >= ab))) {
				L.addClass("aww-landscape").removeClass("aww-portrait")
			} else {
				L.addClass("aww-portrait").removeClass("aww-landscape")
			}
		}
		e("li.submenu > a", q).click(function() {
			
			var ab = e(this).closest("li");
			var aa = ab.hasClass("selected");
			e("> li", q).removeClass("selected showsubmenu");
			if (!aa) {
				ab.addClass("selected showsubmenu")
			}
			return false
		});
		e("li.color ul li a", q).click(function() {
			e("li.color ul li", q).removeClass("selected");
			var aa = e(this).closest("li");
			e.each(g, function(ab) {
				if (aa.hasClass(ab)) {
					S("" + this)
				}
			});
			e("li.color", q).removeClass("selected showsubmenu");
			aa.addClass("selected");
			return false
		});
		function shareclick () {

			e("li.user ul li", q).removeClass("selected");
			var aa = e(this).closest("li");
			e.each(g, function(ab) {
				if (aa.hasClass(ab)) {
					S("" + this)
				}
			});
			e("li.user", q).removeClass("selected showsubmenu");
			aa.addClass("selected");

			N.joinBoard(e(this).attr("id"),function(ab) {
											if (ab) {
												aa.addClass("selected");
												setTimeout(
														function() {
															G.prompt_handler
																	.call(
																			N,
																			Z("Invite people by sharing this URL."),
																			window.location.href)
														}, 500)
											} else {
												G.msgbox_handler
														.call(
																N,
																Z("Cannot share the drawing, sorry"))
											}
										})
			return false
		}
		
		e("li.pencil ul li a", q).click(function() {
			e("li.pencil ul li", q).removeClass("selected");
			var aa = e(this).closest("li");
			A = false;
			W = false;
			if (aa.hasClass("thin")) {
				Q(h)
			} else {
				if (aa.hasClass("medium")) {
					Q(b)
				} else {
					if (aa.hasClass("thick")) {
						Q(f)
					} else {
						if (aa.hasClass("eraser")) {
							A = true
						} else {
							if (aa.hasClass("text")) {
								W = true
							}
						}
					}
				}
			}
			e("li.pencil", q).removeClass("selected showsubmenu");
			aa.addClass("selected");
			return false
		});
		e("li.new a", q)
				.click(
						function() {
							setTimeout(
									function() {
										if (G
												.confirm_handler(Z("This will destroy your current drawing.\nDo you really want to continue?"))) {
											N.doClear()
										}
									}, 100);
							e("li.menu", q).removeClass("selected showsubmenu");
							return false
						});
		e("li.link a", q).click(function() {
			e("li.menu", q).removeClass("selected showsubmenu");
			if (G.post_handler) {
				G.post_handler.call(N)
			} else {
				B("post")
			}
			return false
		});
		e("li.save a", q).click(function() {
			e("li.menu", q).removeClass("selected showsubmenu");
			B("save");
			return false
		});
		e("li.share a", q)
				.click(
						function() {
							var aa = e(this).closest("li");
							e("li.menu", q).removeClass("selected showsubmenu");
							if (G.invite_handler) {
								return G.invite_handler.call(N)
							}
							if (N.isShared()) {
								setTimeout(function() {
									if (G.confirm_handler(Z("Stop sharing?"))) {
										N.leaveBoard();
										aa.removeClass("selected")
									}
								}, 100)
							} else {
								N.joinBoard(function(ab) {
											if (ab) {
												aa.addClass("selected");
												setTimeout(
														function() {
															G.prompt_handler
																	.call(
																			N,
																			Z("Invite people by sharing this URL."),
																			window.location.href)
														}, 500)
											} else {
												G.msgbox_handler
														.call(
																N,
																Z("Cannot share the drawing, sorry"))
											}
										})
							}
							return false
						});
		var O = e('<input type="hidden" name="apikey">').val(G.apiKey || "");
		var n = e('<form target="_blank" method="post">').attr("action",
				G.saveUrl).append(O).append(
				'<input type="hidden" name="action" value="">').append(
				'<input type="hidden" name="image" value="">');
		e(
				'<div style="display: none; position: absolute; width: 0; height: 0;">')
				.append(n).appendTo(L);
		var y = e('<div class="whiteboard">').appendTo(L);
		var x = e(T).css({
			padding : "0",
			margin : "0",
			border : "0",
			shadow : "0",
			overflow : "hidden"
		}).appendTo(y);
		var Y = T.getContext("2d");
		Y.lineCap = "round";
		Y.lineJoin = "round";
		Y.fillStyle = "black";
		Y.globalCompositeOperation = "source-over";
		function E(aa, ab) {
			if (C) {
			} else {
				Y.globalCompositeOperation = "destination-out";
				Y.beginPath();
				Y.arc(aa, ab, c, 0, Math.PI * 2);
				Y.fill();
				Y.globalCompositeOperation = "source-over"
			}
		}
		function F(aa, ae, ab, ad, ac, af) {
			Y.lineCap = "round";
			Y.lineJoin = "round";
			Y.lineWidth = ae;
			Y.strokeStyle = aa;
			Y.beginPath();
			Y.moveTo(ac, af);
			Y.lineTo(ab, ad);
			Y.stroke()
		}
		function U(ac, aa, ae, ad, ab) {
			ab = ab || "bold 12px sans-serif";
			Y.fillStyle = ac;
			Y.font = ab;
			Y.textBaseline = "middle";
			Y.fillText(ad, aa, ae)
		}
		function K() {
			Y.clearRect(0, 0, x.width(), x.height())
		}
		function u() {
			var ab = T.toDataURL();
			if (ab == "data:,") {
				var ac = Y.getImageData(0, 0, T[0].width, T[0].height);
				var aa = new JPEGEncoder(80);
				ab = aa.encode(ac)
			}
			return ab
		}
		function B(aa) {
			aa = aa || "save";
			var ab = u();
			e("input[name='action']", n).val(aa);
			e("input[name='image']", n).val(ab);
			n.submit()
		}
		function i(aa) {
			var ab = u();
			e("input[name='action']", n).val("ajaxsave");
			e("input[name='image']", n).val(ab);
			e.post(n.attr("action"), n.serialize(), function(ac) {
				aa(ac)
			}, "json")
		}
		function m(aa, ad, ab, ac) {
			if (Y.getImageData) {
				return Y.getImageData(aa, ad, ab, ac)
			} else {
				return {}
			}
		}
		function P(af, ac, ae, aa, ag, ab, ad) {
			if (Y.putImageData) {
				return Y.putImageData(af, ac, ae, aa, ag, ab, ad)
			}
		}
		window.allOps = [];
		var N = {
			awwcanvas : L[0],
			options : G,
			toolbar : r[0],
			whiteboard : y[0],
			canvas : T,
			operations : [],
			resize_timeout : null,
			resize : function() {
				o();
				var ab = x.width();
				var ad = x.height();
				var ae = m(0, 0, ab, ad);
				var aa = y.width();
				var ac = y.height();
				if (!G.shrinkCanvas) {
					if (aa < ab) {
						aa = ab
					}
					if (ac < ad) {
						ac = ad
					}
				}
				if (ab > aa) {
					ab = aa
				}
				if (ad > ac) {
					ad = ac
				}
				x.attr({
					width : aa,
					height : ac
				});
				P(ae, 0, 0, 0, 0, ab, ad)
			},
			doErase : function(aa, ab) {
				this.addOp("doErase", {
					x : aa,
					y : ab
				});
				E(aa, ab)
			},
			doDrawLine : function(aa, ae, ab, ad, ac, af) {
				this.addOp("doLine", {
					color : aa,
					width : ae,
					x1 : ab,
					y1 : ad,
					x0 : ac,
					y0 : af
				});
				F(aa, ae, ab, ad, ac, af)
			},
			doDrawText : function(ac, aa, ae, ad, ab) {
				this.addOp("doText", {
					color : ac,
					text : ad,
					x : aa,
					y : ae,
					font : ab
				});
				U(ac, aa, ae, ad, ab)
			},
			doClear : function() {
				this.operations = [];
				this.addOp("doClear", {});
				K()
			},
			saveImage : function() {
				B("save")
			},
			postImage : function() {
				B("post")
			},
			doAjaxPostImage : function(aa) {
				i(aa)
			},
			addOp : function(ab, aa) {
				aa.op = ab;
				//New design for WebRTC.
				now.sendOpBatch(null, aa, null);
			},
			
			replayOps : function(ac) {

				window.totalOps++;
				window.allOps.push(ac);
				if (ac.op == "doErase") {
					E(ac.x, ac.y)
				} else {
					if (ac.op == "doLine") {
						F(ac.color, ac.width, ac.x1, ac.y1, ac.x0, ac.y0)
					} else {
						if (ac.op == "doText") {
							U(ac.color, ac.x, ac.y, ac.text, ac.font
									|| G.font)
						} else {
							if (ac.op == "doClear") {
								K()
							}
						}
					}
				}
			},
			isShared : function() {
				if (now.getConnNum() > 0) {
					return true
				} else {
					return false
				}
			},
			/*
			getBoardId : function() {
				return this.board_id
			},
			*/
			joinBoard : function(id, aa) {
				aa = aa || function() {
				};
				if (!window.now) {
					aa.call(N, null);
					return
				}
				//alert("ID: "+id);
				//var id = prompt("Input ID ");
				now.joinBoard(id, function(ac) {
					if (ac) {

						aa.call(N, ab)
					} else {

						aa.call(N, null)
					}
				})
			},
			createBoard : function(aa) {
				aa = aa || function() {
				};
				if (!window.now) {
					aa.call(N, false);
					return
				}

				window.location.hash = now.id;
				aa.call(N, now.id)
			},
			createNamedBoard : function(ab, aa) {
				aa = aa || function() {
				};
				if (!window.now) {
					aa.call(N, null);
					return
				}
				now.createNamedBoard(ab, function(ac) {
					if (ac === null) {
						aa.call(N, null)
					} else {
						window.location.hash = ac;
						N.joinBoard(ac, aa)
					}
				})
			},
			leaveBoard : function(aa) {
				if (!this.board_id) {
					return
				}
				if (!aa) {
					now.leaveBoard(this.board_id)
				}
				window.location.hash = "";
				this.board_id = null
			}
		};
		window.totalOps = 0;
		var R = false;
		var v = null;
		var w = null;
		function X(ab) {
			R = true;
			var ac = y.offset();
			var aa = ab.pageX - ac.left;
			var ad = ab.pageY - ac.top;
			if (A) {
				N.doErase(aa, ad)
			} else {
				if (W) {
					setTimeout(function() {
						var ae = G.prompt_handler.call(N, Z("Enter text"), "");
						if (ae) {
							N.doDrawText(I, aa, ad, ae, G.font)
						}
					}, 200)
				} else {
					v = aa;
					w = ad;
					N.doDrawLine(I, l, aa, ad, aa, ad)
				}
			}
			return false
		}
		function k(ab) {
			if (!R) {
				return false
			}
			var ac = y.offset();
			var aa = ab.pageX - ac.left;
			var ad = ab.pageY - ac.top;
			if (A) {
				N.doErase(aa, ad)
			} else {
				if (W) {
				} else {
					N.doDrawLine(I, l, aa, ad, v, w);
					v = aa;
					w = ad
				}
			}
			return false
		}
		function j(ab) {
			if (!R) {
				return false
			}
			var ac = y.offset();
			if (!A && !W) {
				var aa = ab.pageX - ac.left;
				var ad = ab.pageY - ac.top;
				if (ad == w) {
					ad += 1
				}
				N.doDrawLine(I, l, aa, ad, v, w)
			}
			v = null;
			w = null;
			R = false;
			return false
		}
		function s() {
			R = false;
			return false
		}
		y.mousedown(X);
		y.mousemove(k);
		y.mouseup(j);
		y.mouseleave(s);
		e("li.color li.black a", q).click();
		e("li.pencil li.medium a", q).click();
		e("li.share a", q).hide();
		if (window.now) {
			now.receiveOplog = function(ab, aa) {

				N.replayOps(ab);
				if (aa) {
					aa()
				}
			};
			
			now.addUser = AddUser;
			if (user.length > 0) {
				for (var i = 0, ii = user.length; i < ii; i += 1) {
					//alert('For: '+user[i]);
					AddUser(user[i].name,user[i].uid);
				}
				user = [];
			}
			e("li.share a", q).show();
			now.ready(function() {
						now.apiKey = G.apiKey;
						now.referer = window.location.href.split(/#/)[0];
						e("li.share a", q).show();
						if (N.isShared()) {
							var aa = N.getBoardId();
							N.leaveBoard(true);
							e("li.share", q).removeClass("selected");
							N.joinBoard(aa,function(ab) {
												if (ab) {
													e("li.share", q).addClass(
															"selected")
												} else {
													G.msgbox_handler
															.call(
																	N,
																	Z("Lost connection to shared drawing"))
												}
											})
						} else {
							G.onReady();
							if (G.autoJoin) {
								var aa = "";
								if (G.singleBoardId) {
									aa = G.singleBoardId;
									e("li.share a", q).hide();
									N
											.createNamedBoard(
													aa,
													function(ab) {
														if (!ab) {
															G.msgbox_handler
																	.call(
																			N,
																			Z("Can't join shared drawing at this time"))
														}
													});
									return
								}
								if (window.location.hash) {
									aa = window.location.hash;
									if (aa.indexOf("#") == 0) {
										aa = aa.slice(1)
									}
								}
								if (aa.length > 0) {
									N.joinBoard(aa,function(ab) {
														if (ab) {
															e("li.share", q)
																	.addClass(
																			"selected")
														} else {
															G.msgbox_handler
																	.call(
																			N,
																			Z("Can't join shared drawing (it probably doesn't exist any more)"))
														}
													})
								}
							}
						}
					})
		} else {
			window.location.hash = ""
		}
		if (C) {
			e("li.pencil ul li.eraser", q).hide()
		}
		e(this).data("aww", N).append(L);
		N.resize();
		return N
	}
})(jQuery);
